#!/usr/bin/env bash

# Runs dbt from the local virtualenv, setting up the virtualenv if necessary.

set -euo pipefail

cd "$(dirname "$0")/.."

if [[ ! -f venv/bin/activate ]]; then
    rm -rf venv
    python3 -m venv venv
fi

# shellcheck source=/dev/null
source venv/bin/activate

if [[ ! -x venv/bin/dbt ]]; then
    pip install -r requirements.txt
fi

DBT_PROFILES_DIR=$(pwd)
DBT_ARTIFACT_STATE_PATH=$(pwd)

export DBT_PROFILES_DIR
export DBT_ARTIFACT_STATE_PATH

exec venv/bin/dbt "$@"
